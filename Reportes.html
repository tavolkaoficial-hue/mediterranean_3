<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Ejecutivo Premium - Mediterranean</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* === Estilos generales === */
body { margin:0; font-family: Arial,sans-serif; background:#0d1117; color:#fff; }
.sidebar { position: fixed; top:0; left:0; width:240px; height:100%; background:#0a1f3d; padding-top:40px; display:flex; flex-direction:column; gap:20px; box-shadow:2px 0 25px rgba(0,0,0,0.8); }
.sidebar a { color:#00f2fe; text-decoration:none; padding:12px 20px; font-weight:bold; border-radius:8px; display:flex; align-items:center; gap:10px; transition:all 0.3s; }
.sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.1); transform:translateX(6px) scale(1.05); }
.main-content { margin-left:260px; padding: 20px 40px; }
h1 { margin-bottom:20px; }
.kpi-cards { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:30px; }
.kpi-card { flex:1; min-width:220px; background: rgba(0,242,254,0.1); padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.4); transition:all 0.3s; }
.kpi-card.low-stock { background: rgba(255,50,50,0.2); color:#ffcccc; }
.kpi-card:hover { transform:scale(1.05); }
.tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tabs button { background:#00f2fe; color:#000; border:none; padding:10px 15px; font-weight:bold; border-radius:8px; cursor:pointer; }
.tabs button:hover { background:#4facfe; color:#fff; transform:scale(1.05); }
.tab-content { display:none; }
.tab-content.active { display:block; }
.filters { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
.filters select, .filters input { padding:8px 12px; border-radius:8px; border:none; outline:none; }
table { width:100%; border-collapse:collapse; margin-top:10px; background: rgba(255,255,255,0.05); border-radius:10px; }
th, td { padding:12px; text-align:center; }
th { background: rgba(0,0,0,0.7); color:#00f2fe; position:sticky; top:0; }
tbody tr:nth-child(even) { background: rgba(255,255,255,0.05); }
tbody tr:hover { background: rgba(0,242,254,0.15); }
.actions { margin: 15px 0; display:flex; gap:15px; flex-wrap:wrap; }
.actions button { background:linear-gradient(90deg,#00f2fe,#4facfe); border:none; padding:10px 15px; border-radius:8px; color:white; cursor:pointer; font-weight:bold; }
.actions button:hover { transform:scale(1.05); }
.chart-container { background: rgba(255,255,255,0.05); padding:20px; border-radius:12px; margin-bottom:20px; }
.alert { color:#ff5555; font-weight:bold; margin-bottom:10px; }
</style>
</head>
<body>

<div class="sidebar">
  <a href="#"><i class="fas fa-home"></i> Menu Principal</a>
  <a href="#" class="active"><i class="fas fa-chart-bar"></i> Reportes</a>
</div>

<div class="main-content">
  <h1>Dashboard Ejecutivo Premium</h1>

  <div class="kpi-cards">
    <div class="kpi-card" id="kpi-stock">Stock total: 0</div>
    <div class="kpi-card" id="kpi-faltantes">Productos faltantes: 0</div>
    <div class="kpi-card" id="kpi-movimientos">Movimientos recientes: 0</div>
    <div class="kpi-card" id="kpi-usuarios">Usuarios activos: 0</div>
  </div>

  <div class="tabs">
    <button onclick="showTab('stock')">Stock por Sucursal</button>
    <button onclick="showTab('movimientos')">Movimientos</button>
    <button onclick="showTab('usuarios')">Usuarios</button>
    <button onclick="showTab('ventas')">Resumen Ventas</button>
  </div>

  <div id="tab-stock" class="tab-content active">
    <div class="filters">
      <select id="filterSucursal"></select>
      <select id="filterProducto"></select>
      <input type="date" id="filterFechaInicio">
      <input type="date" id="filterFechaFin">
      <button onclick="aplicarFiltros('stock')">Filtrar</button>
    </div>
    <div class="alert" id="alert-stock"></div>
    <div class="actions">
      <button onclick="exportarExcel('stock')"><i class="fas fa-file-excel"></i> Exportar Excel</button>
      <button onclick="exportarPDF('stock')"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    </div>
    <div class="chart-container"><canvas id="chartStock" height="150"></canvas></div>
    <table id="tableStock"></table>
  </div>

  <div id="tab-movimientos" class="tab-content">
    <div class="filters">
      <select id="filterMovSucursal"></select>
      <select id="filterMovProducto"></select>
      <input type="date" id="filterMovInicio">
      <input type="date" id="filterMovFin">
      <button onclick="aplicarFiltros('movimientos')">Filtrar</button>
    </div>
    <div class="actions">
      <button onclick="exportarExcel('movimientos')"><i class="fas fa-file-excel"></i> Exportar Excel</button>
      <button onclick="exportarPDF('movimientos')"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    </div>
    <table id="tableMovimientos"></table>
  </div>

  <div id="tab-usuarios" class="tab-content">
    <div class="filters">
      <input type="text" id="filterUsuarioNombre" placeholder="Buscar usuario...">
      <button onclick="aplicarFiltros('usuarios')">Filtrar</button>
    </div>
    <div class="actions">
      <button onclick="exportarExcel('usuarios')"><i class="fas fa-file-excel"></i> Exportar Excel</button>
      <button onclick="exportarPDF('usuarios')"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    </div>
    <table id="tableUsuarios"></table>
  </div>

  <div id="tab-ventas" class="tab-content">
    <div class="chart-container"><canvas id="chartVentas" height="200"></canvas></div>
    <div class="chart-container"><canvas id="chartMovimientosTipo" height="200"></canvas></div>
  </div>
</div>

<script>
function showTab(tab){
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
}

let dataStock=[], dataMovimientos=[], dataUsuarios=[], sucursales=[];

async function cargarDatos(){
  try {
    const sucResp = await fetch('obtener_sucursales.php');
    const sucData = await sucResp.json();
    sucursales = (sucData.success && sucData.sucursales.length > 0) ? sucData.sucursales : ["Centro","Kennedy","Norte"];

    const stockResp = await fetch('stock_por_sucursal.php');
    dataStock = await stockResp.json();

    const movResp = await fetch('movimientos_recientes.php');
    dataMovimientos = await movResp.json();

    const userResp = await fetch('obtener_todos_usuarios.php');
    const userData = await userResp.json();
    if(userData.success) dataUsuarios = userData.users;

    renderStock(dataStock);
    renderStockChart(dataStock);
    renderMovimientos(dataMovimientos);
    renderUsuarios(dataUsuarios);
    renderResumenVentas(dataMovimientos);
    llenarFiltros('stock');
    llenarFiltros('movimientos');
    actualizarKPIs();
    verificarStockBajo();
  } catch(e){ console.error("Error al cargar datos:", e); }
}

function actualizarKPIs(){
  document.getElementById('kpi-stock').innerText='Stock total: '+dataStock.reduce((a,b)=>a+parseInt(b.stock||0),0);
  document.getElementById('kpi-faltantes').innerText='Productos faltantes: '+dataStock.filter(p=>p.stock<=0).length;
  document.getElementById('kpi-movimientos').innerText='Movimientos recientes: '+dataMovimientos.length;
  document.getElementById('kpi-usuarios').innerText='Usuarios activos: '+dataUsuarios.length;
}

function verificarStockBajo(){
  let bajos = dataStock.filter(p=>p.stock<=5);
  document.getElementById('alert-stock').innerText = bajos.length>0 ? "⚠️ Productos con stock crítico: "+bajos.map(p=>`${p.nombre_producto} (${p.nombre_sucursal})`).join(", ") : "";
}

function renderStock(data){
  const table = document.getElementById('tableStock');
  table.innerHTML="<tr><th>Sucursal</th><th>Producto</th><th>Stock</th></tr>";
  data.forEach(r=>{ table.innerHTML+=`<tr><td>${r.nombre_sucursal}</td><td>${r.nombre_producto}</td><td>${r.stock}</td></tr>`; });
}

function renderStockChart(data){
  const ctx=document.getElementById('chartStock').getContext('2d');
  const labels=data.map(r=>r.nombre_producto+' ('+r.nombre_sucursal+')');
  const stocks=data.map(r=>parseInt(r.stock));
  new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Stock',data:stocks,backgroundColor:'#0ea5e9'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

function renderMovimientos(data){
  const table=document.getElementById('tableMovimientos');
  table.innerHTML="<tr><th>ID</th><th>Producto</th><th>Sucursal</th><th>Tipo</th><th>Cantidad</th><th>Comentario</th><th>Fecha</th></tr>";
  data.forEach(r=>{ table.innerHTML+=`<tr><td>${r.id}</td><td>${r.nombre_producto}</td><td>${r.nombre_sucursal}</td><td>${r.tipo_movimiento}</td><td>${r.cantidad}</td><td>${r.comentario}</td><td>${r.fecha}</td></tr>`; });
}

function renderUsuarios(data){
  const table=document.getElementById('tableUsuarios');
  table.innerHTML="<tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Foto</th></tr>";
  data.forEach(r=>{ table.innerHTML+=`<tr><td>${r.id}</td><td>${r.usuarios}</td><td>${r.correo}</td><td>${r.rol}</td><td><img src="${r.foto}" width="48" height="48" style="border-radius:50%"></td></tr>`; });
}

function renderResumenVentas(data){
  const ventasCtx=document.getElementById('chartVentas').getContext('2d');
  const productos=[...new Set(data.map(d=>d.nombre_producto))];
  const cantidades=productos.map(p=>data.filter(d=>d.nombre_producto===p).reduce((a,b)=>a+parseInt(b.cantidad||0),0));
  new Chart(ventasCtx,{type:'pie',data:{labels:productos,datasets:[{data:cantidades,backgroundColor:productos.map(()=>`hsl(${Math.random()*360},70%,50%)`)}]},options:{responsive:true}});

  const movCtx=document.getElementById('chartMovimientosTipo').getContext('2d');
  const tipos=['Entrada','Salida'];
  const counts=tipos.map(t=>data.filter(d=>d.tipo_movimiento===t).length);
  new Chart(movCtx,{type:'doughnut',data:{labels:tipos,datasets:[{data:counts,backgroundColor:['#0ea5e9','#f43f5e']}]},options:{responsive:true}});
}

function llenarFiltros(tab){
  if(tab==='stock'){
    const suc=document.getElementById('filterSucursal');
    const prod=document.getElementById('filterProducto');
    suc.innerHTML='<option value="">Todas Sucursales</option>';
    // Obtener sucursales únicas del stock
    const sucursalesUnicas = [...new Set(dataStock.map(d => d.nombre_sucursal))];
    sucursalesUnicas.forEach(s => suc.innerHTML += `<option>${s}</option>`);

    const productos=[...new Set(dataStock.map(d=>d.nombre_producto))];
    prod.innerHTML='<option value="">Todos Productos</option>';
    productos.forEach(p=>prod.innerHTML+=`<option>${p}</option>`);
  }
  if(tab==='movimientos'){
    const suc=document.getElementById('filterMovSucursal');
    const prod=document.getElementById('filterMovProducto');
    suc.innerHTML='<option value="">Todas Sucursales</option>';
    const sucursalesUnicas = [...new Set(dataMovimientos.map(d => d.nombre_sucursal))];
    sucursalesUnicas.forEach(s => suc.innerHTML += `<option>${s}</option>`);

    const productos=[...new Set(dataMovimientos.map(d=>d.nombre_producto))];
    prod.innerHTML='<option value="">Todos Productos</option>';
    productos.forEach(p=>prod.innerHTML+=`<option>${p}</option>`);
  }
}


cargarDatos();
</script>
</body>
</html>
