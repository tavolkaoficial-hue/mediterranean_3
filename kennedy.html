<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sucursal Kennedy - Mediterranean (Avanzado)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetJS (XLSX) para Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- jsPDF + html2canvas para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --azul-neon:#00f2fe;
  --glass: rgba(255,255,255,0.06);
  --bg-grad: linear-gradient(135deg,#001f3f,#004e92);
  --text:#ffffff;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,Segoe UI,Arial; background:var(--bg-grad); color:var(--text);
}
#background,#particles{position:fixed;inset:0;width:100%;height:100%;z-index:-2}
#particles{z-index:-1;pointer-events:none}

/* Sidebar */
.sidebar{
  position:fixed;left:0;top:0;height:100%;width:260px;
  background:linear-gradient(180deg,#041427,#0a1f44); padding:28px 18px;
  box-shadow:3px 0 24px rgba(0,0,0,0.6);
}
.sidebar h2{color:var(--azul-neon);margin:6px 0 20px;font-size:20px;text-align:center}
.sidebar a{display:flex;align-items:center;gap:10px;color:#dff6fb;text-decoration:none;padding:10px;border-radius:8px;margin:8px 0}
.sidebar a:hover{background:rgba(0,242,254,0.08);color:#fff;transform:translateX(6px)}
.sidebar .small{font-size:0.85rem;opacity:0.85}

/* Main */
.main{margin-left:300px;padding:28px 32px}
.header{display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap}
.branch-card{
  background:var(--glass); padding:18px;border-radius:14px;border:1px solid rgba(0,242,254,0.08);
  box-shadow:0 6px 30px rgba(0,0,0,0.35);
  display:flex;gap:20px;align-items:center;
}
.branch-info h1{margin:0;color:var(--azul-neon);font-size:20px}
.branch-info p{margin:3px 0;font-size:0.95rem;opacity:0.95}

/* Controls */
.controls{display:flex;gap:12px;align-items:center}
.search {
  background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.04);color:var(--text);
  padding:8px 12px;border-radius:10px;min-width:260px;
}
.btn {
  background:linear-gradient(90deg,#00bcd4,#00f2fe);color:#003047;border:none;padding:9px 12px;border-radius:10px;
  cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(0,242,254,0.12);
}
.btn.secondary { background:transparent;color:#cbeff6;border:1px solid rgba(255,255,255,0.06) }

/* Layout panels */
.grid {display:grid;grid-template-columns: 1fr 420px; gap:20px;margin-top:20px}
.left-col{display:flex;flex-direction:column;gap:18px}
.panel{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
.panel h3{margin:0 0 10px;color:var(--azul-neon)}

/* Table */
.table-wrap{max-height:260px;overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse;color:#eafcff}
th,td{padding:10px 12px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.95rem}
th{background:rgba(0,242,254,0.06);color:#eaffff}

/* Chart area */
.chart-card{height:300px;padding:12px;display:flex;flex-direction:column;justify-content:center}

/* Responsive */
@media (max-width:1000px){
  .grid{grid-template-columns:1fr; }
  .chart-card{height:260px}
  .main{padding:18px}
}

/* map style */
#map{height:260px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);margin-top:12px}
.footer{margin-top:18px;text-align:center;color:#dff6fb;font-size:0.9rem;opacity:0.9}
</style>
</head>
<body>

<div id="background"></div>
<canvas id="particles"></canvas>

<!-- SIDEBAR -->
<nav class="sidebar">
  <h2><i class="fa-solid fa-leaf"></i> Mediterranean</h2>
  <a href="sucursales.html"><i class="fa-solid fa-arrow-left"></i> Volver a sucursales</a>
  <a href="#"><i class="fa-solid fa-boxes-stacked"></i> Inventario</a>
  <a href="#"><i class="fa-solid fa-file-export"></i> Exportar</a>
  <div style="height:10px"></div>
  <span class="small">Usuario: <strong>Supervisor</strong></span>
</nav>

<!-- MAIN -->
<main class="main">
  <div class="header">
    <div class="branch-card" style="flex:1">
      <div style="width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#003f6b,#006b9a);display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff">
        <i class="fa-solid fa-store"></i>
      </div>
      <div class="branch-info">
        <h1>Sucursal Kennedy</h1>
        <p><strong>Direcci√≥n:</strong> Calle 10 # 68-25, Barrio El Socorro</p>
        <p><strong>Tel:</strong> +57 321 9513533 &nbsp; ‚Ä¢ &nbsp; <strong>Supervisor:</strong> Carlos P√©rez</p>
      </div>
    </div>

    <div class="controls">
      <input id="searchInput" class="search" placeholder="Buscar producto (nombre o categoria)..." />
      <button id="btnExportExcel" class="btn">Exportar Excel</button>
      <button id="btnExportPDF" class="btn secondary">Exportar PDF</button>
    </div>
  </div>

  <div class="grid">
    <!-- left: tablas y listas -->
    <div class="left-col">
      <div class="panel">
        <h3>üì¶ Stock actual</h3>
        <div class="table-wrap">
          <table id="stockTable">
            <thead>
              <tr><th>Producto</th><th>Categoria</th><th>Cantidad</th><th>√öltima</th></tr>
            </thead>
            <tbody>
              <!-- Datos iniciales (modificables por JS) -->
              <tr><td>Aceite de Oliva Premium</td><td>Alimentos</td><td data-stock="240">240</td><td>28/10/2025</td></tr>
              <tr><td>Vino Tinto Mediterr√°neo</td><td>Bebidas</td><td data-stock="130">130</td><td>27/10/2025</td></tr>
              <tr><td>Harina de Trigo Italiana</td><td>Alimentos</td><td data-stock="400">400</td><td>28/10/2025</td></tr>
              <tr><td>Queso Manchego</td><td>Alimentos</td><td data-stock="80">80</td><td>25/10/2025</td></tr>
              <tr><td>Vino Blanco</td><td>Bebidas</td><td data-stock="50">50</td><td>26/10/2025</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>‚¨ÜÔ∏è Entradas recientes</h3>
        <div class="table-wrap">
          <table id="entradasTable">
            <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
            <tbody>
              <tr><td>Queso Manchego</td><td data-val="80">80</td><td>25/10/2025</td></tr>
              <tr><td>Vino Blanco</td><td data-val="50">50</td><td>26/10/2025</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>‚¨áÔ∏è Salidas recientes</h3>
        <div class="table-wrap">
          <table id="salidasTable">
            <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
            <tbody>
              <tr><td>Aceite de Oliva Premium</td><td data-val="40">40</td><td>28/10/2025</td></tr>
              <tr><td>Harina de Trigo Italiana</td><td data-val="60">60</td><td>27/10/2025</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- right: chart + map -->
    <div>
      <div class="panel chart-card">
        <h3 style="text-align:center">üìä Inventario ‚Äî Stock / Entradas / Salidas</h3>
        <canvas id="inventoryChart"></canvas>
      </div>

      <div class="panel">
        <h3>üìç Ubicaci√≥n</h3>
        <div id="map"></div>
      </div>
    </div>
  </div>

  <div class="footer">¬© 2025 Mediterranean Technologies ‚Äî Sucursal Kennedy</div>
</main>

<!-- SCRIPTS -->
<script>
/* ------------------------
   Part√≠culas livianas
   ------------------------ */
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
function resizeParticles(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resizeParticles(); window.addEventListener('resize', resizeParticles);
let particles = [];
function makeParticles(n=80){
  particles = [];
  for(let i=0;i<n;i++){
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      r: Math.random()*1.8+0.6,
      vx: (Math.random()-0.5)*0.4,
      vy: (Math.random()-0.5)*0.4
    });
  }
}
makeParticles(90);
function drawParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'rgba(0,242,254,0.08)';
  particles.forEach(p=>{
    p.x += p.vx; p.y += p.vy;
    if(p.x<0||p.x>canvas.width) p.vx *= -1;
    if(p.y<0||p.y>canvas.height) p.vy *= -1;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  requestAnimationFrame(drawParticles);
}
drawParticles();

/* ------------------------
   Map (Leaflet)
   ------------------------ */
const map = L.map('map').setView([4.6195,-74.1673],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([4.6195,-74.1673]).addTo(map).bindPopup('<b>Sucursal Kennedy</b>').openPopup();

/* ------------------------
   Datos base (extra√≠dos de la tabla)
   ------------------------ */
function readStockRows(){
  const rows = Array.from(document.querySelectorAll('#stockTable tbody tr'));
  return rows.map(r=>{
    const name = r.children[0].textContent.trim();
    const cat  = r.children[1].textContent.trim();
    const qty  = Number(r.children[2].getAttribute('data-stock') || r.children[2].textContent.trim());
    return {name,cat,qty};
  });
}
let stockData = readStockRows();

/* ------------------------
   Chart.js - inventario
   ------------------------ */
const ctxChart = document.getElementById('inventoryChart').getContext('2d');
let inventoryChart = null;

function buildChart(dataArr){
  const labels = dataArr.map(d=>d.name);
  // compute entradas & salidas totals per product (search in tables)
  const entradas = labels.map(l=>{
    const row = Array.from(document.querySelectorAll('#entradasTable tbody tr')).find(tr => tr.children[0].textContent.trim()===l);
    return row ? Number(row.children[1].getAttribute('data-val') || row.children[1].textContent) : 0;
  });
  const salidas = labels.map(l=>{
    const row = Array.from(document.querySelectorAll('#salidasTable tbody tr')).find(tr => tr.children[0].textContent.trim()===l);
    return row ? Number(row.children[1].getAttribute('data-val') || row.children[1].textContent) : 0;
  });
  const stock = dataArr.map(d => d.qty);

  const datasets = [
    { label:'Stock', data:stock, backgroundColor:'rgba(0,242,254,0.9)', borderColor:'rgba(0,242,254,0.9)', borderWidth:1 },
    { label:'Entradas', data:entradas, backgroundColor:'rgba(80,200,120,0.9)', borderColor:'rgba(80,200,120,0.9)', borderWidth:1 },
    { label:'Salidas', data:salidas, backgroundColor:'rgba(255,140,90,0.95)', borderColor:'rgba(255,140,90,0.95)', borderWidth:1 }
  ];

  if(inventoryChart) inventoryChart.destroy();
  inventoryChart = new Chart(ctxChart, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive:true,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top'}},
      scales:{
        x:{ stacked: false, ticks:{color:'#dff6fb'}},
        y:{ beginAtZero:true, ticks:{color:'#dff6fb'} }
      }
    }
  });
}
buildChart(stockData);

/* ------------------------
   Buscador (filtra tabla y actualiza gr√°fica)
   ------------------------ */
const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('input', e=>{
  const q = e.target.value.trim().toLowerCase();
  const rows = document.querySelectorAll('#stockTable tbody tr');
  const visible = [];
  rows.forEach(r=>{
    const name = r.children[0].textContent.toLowerCase();
    const cat  = r.children[1].textContent.toLowerCase();
    const match = !q || name.includes(q) || cat.includes(q);
    r.style.display = match ? '' : 'none';
    if(match) visible.push({name: r.children[0].textContent.trim(), cat: r.children[1].textContent.trim(), qty: Number(r.children[2].getAttribute('data-stock')||r.children[2].textContent)});
  });
  // if search empty, use full
  buildChart( visible.length ? visible : readStockRows() );
});

/* ------------------------
   Export to Excel (SheetJS)
   ------------------------ */
document.getElementById('btnExportExcel').addEventListener('click', ()=>{
  const table = document.getElementById('stockTable');
  const wb = XLSX.utils.table_to_book(table, {sheet:"Stock"});
  // add entradas and salidas as additional sheets
  const entradasWb = XLSX.utils.table_to_sheet(document.getElementById('entradasTable'));
  const salidasWb  = XLSX.utils.table_to_sheet(document.getElementById('salidasTable'));
  wb.Sheets['Entradas'] = entradasWb;
  wb.Sheets['Salidas'] = salidasWb;
  // ensure workbook has order
  wb.SheetNames = ["Stock","Entradas","Salidas"];
  XLSX.writeFile(wb, "sucursal_kennedy_inventario.xlsx");
});

/* ------------------------
   Export to PDF (html2canvas + jsPDF)
   ------------------------ */
document.getElementById('btnExportPDF').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  // create a snapshot of the stock table + chart area
  const panel = document.createElement('div');
  panel.style.background = '#001f3f';
  panel.style.color = '#fff';
  panel.style.padding = '14px';
  panel.style.borderRadius = '8px';
  panel.style.width = '900px';
  // clone table
  const tableClone = document.getElementById('stockTable').cloneNode(true);
  tableClone.style.width = '100%';
  tableClone.style.borderCollapse = 'collapse';
  panel.appendChild(document.createElement('h3')).innerText = 'Stock - Sucursal Kennedy';
  panel.appendChild(tableClone);

  document.body.appendChild(panel); // required for html2canvas to render styles
  const canvas = await html2canvas(panel, { scale: 2, backgroundColor: '#001f3f' });
  document.body.removeChild(panel);

  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','pt','a4');
  const margin = 20;
  const pdfWidth = pdf.internal.pageSize.getWidth() - margin*2;
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData, 'PNG', margin, 40, pdfWidth, pdfHeight);
  pdf.save('sucursal_kennedy_stock.pdf');
});

/* ------------------------
   (Opcional) actualizar stock desde entradas/salidas (demo)
   ------------------------ */
function applyMovementsToStock(){
  // read stock rows into map
  const rows = Array.from(document.querySelectorAll('#stockTable tbody tr'));
  const mapStock = new Map(rows.map(r=>[r.children[0].textContent.trim(), r]));
  // apply entradas
  Array.from(document.querySelectorAll('#entradasTable tbody tr')).forEach(tr=>{
    const name = tr.children[0].textContent.trim();
    const qty = Number(tr.children[1].getAttribute('data-val') || tr.children[1].textContent);
    if(mapStock.has(name)){
      const row = mapStock.get(name);
      const cell = row.children[2];
      let newVal = Number(cell.getAttribute('data-stock')||cell.textContent) + qty;
      cell.setAttribute('data-stock', newVal);
      cell.textContent = newVal;
    }
  });
  // apply salidas
  Array.from(document.querySelectorAll('#salidasTable tbody tr')).forEach(tr=>{
    const name = tr.children[0].textContent.trim();
    const qty = Number(tr.children[1].getAttribute('data-val') || tr.children[1].textContent);
    if(mapStock.has(name)){
      const row = mapStock.get(name);
      const cell = row.children[2];
      let newVal = Number(cell.getAttribute('data-stock')||cell.textContent) - qty;
      if(newVal < 0) newVal = 0;
      cell.setAttribute('data-stock', newVal);
      cell.textContent = newVal;
    }
  });
  // refresh chart data
  stockData = readStockRows();
  buildChart(stockData);
}
// optional demo: uncomment to apply movements on load
// applyMovementsToStock();


</script>
</body>
</html>
